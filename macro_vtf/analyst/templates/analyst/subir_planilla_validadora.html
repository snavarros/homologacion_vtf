{% extends 'analyst/base.html' %}
{% load static %}

{% block title %}Subir Archivo{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center bg-gray-50 p-4">
  <div class="max-w-2xl w-full p-6 bg-white rounded shadow-md">

    <h2 class="text-2xl font-semibold text-gray-800 mb-6 text-center">Subir Planilla Mensual</h2>

    {# Mensajes de √©xito o error #}
    {% if estado_subida == 'exito' %}
      <div class="mb-6 p-4 bg-green-100 border border-green-300 rounded text-green-800 text-center font-semibold">
        {% for detalle in detalles_validacion %}
          <p>{{ detalle }}</p>
        {% endfor %}
        <p>Ser√°s redirigido en <span id="contador">20</span> segundos...</p>
      </div>
    {% elif estado_subida == 'error' %}
      <div class="mb-6 p-4 bg-red-100 border border-red-300 rounded text-red-800 font-semibold">
        <p class="mb-2">Se han encontrado los siguientes errores:</p>
        <ul class="list-disc list-inside">
          {% for detalle in detalles_validacion %}
            <li>{{ detalle }}</li>
          {% endfor %}
        </ul>
        {% if archivo_existe %}
          <p class="mt-4 font-semibold">
            Ya existe un archivo para esta combinaci√≥n. Debe eliminarlo desde la p√°gina de <a href="{% url 'listar_archivos' %}" class="underline text-blue-600 hover:text-blue-800">archivos subidos</a> antes de volver a subir uno nuevo.
          </p>
        {% endif %}
      </div>
    {% endif %}

    {# Formulario normal para subir archivo #}
    <form method="post" enctype="multipart/form-data" class="space-y-6" id="form-subir">
      {% csrf_token %}
      <div>
          <label for="id_anio" class="block mb-1 font-medium text-gray-700">A√±o<span class="text-red-500">*</span></label>
          {{ form.anio }}
          {% if form.anio.errors %}
              <p class="mt-1 text-sm text-red-600">{{ form.anio.errors.0 }}</p>
          {% endif %}
      </div>

      <div>
          <label for="id_mes" class="block mb-1 font-medium text-gray-700">Mes<span class="text-red-500">*</span></label>
          {{ form.mes }}
          {% if form.mes.errors %}
              <p class="mt-1 text-sm text-red-600">{{ form.mes.errors.0 }}</p>
          {% endif %}
      </div>

      <div>
          <label for="id_archivo" class="block mb-1 font-medium text-gray-700">Archivo<span class="text-red-500">*</span></label>
          <div id="dropzone" class="w-full border-2 border-dashed border-blue-300 rounded p-6 text-center transition hover:bg-blue-50 cursor-pointer">
              <p class="text-gray-500">Arrastra un archivo aqu√≠ o haz clic para seleccionar</p>
              {{ form.archivo }}
          </div>
          {% if form.archivo.errors %}
              <p class="mt-1 text-sm text-red-600">{{ form.archivo.errors.0 }}</p>
          {% endif %}
      </div>

      <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
          <button type="submit" id="submit-btn" disabled
            class="bg-gray-400 text-white px-6 py-2 rounded cursor-not-allowed"
          >
              Subir Archivo
          </button>

          <a href="{% static 'plantillas/planilla_validadora_template.xlsx' %}" download
             class="inline-block border-2 border-dashed border-gray-400 text-gray-600 px-4 py-2 rounded hover:bg-gray-100 transition text-center select-none"
             title="Descarga la plantilla oficial Excel">
              üì• Descargar plantilla oficial
          </a>
      </div>
    </form>

  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Para ocultar dropzone tras √©xito
    const messages = document.querySelectorAll("[class*='bg-green-']");
    if (messages.length > 0) {
        const dropzone = document.getElementById("dropzone");
        if (dropzone) {
            dropzone.style.display = "none";
        }

        // Redirecci√≥n despu√©s de 20 segundos si existe URL para redireccionar
        {% if redireccionar_url %}
        let segundos = {{ redireccionar_segundos|default:20 }};
        const contador = document.getElementById("contador");
        const intervalo = setInterval(() => {
            segundos--;
            if (contador) contador.textContent = segundos;
            if (segundos <= 0) {
                clearInterval(intervalo);
                window.location.href = "{{ redireccionar_url }}";
            }
        }, 1000);
        {% endif %}
    }

    // Control para el dropzone y el bot√≥n deshabilitado si no hay valores
    const inputArchivo = document.getElementById("id_archivo");
    const inputAnio = document.getElementById("id_anio");
    const inputMes = document.getElementById("id_mes");
    const submitBtn = document.getElementById("submit-btn");

    if (inputArchivo) {
        inputArchivo.classList.add("hidden");
        const dropzone = document.getElementById("dropzone");
        dropzone.addEventListener("click", () => inputArchivo.click());
        inputArchivo.addEventListener("change", () => {
            dropzone.querySelector("p").textContent = inputArchivo.files[0]?.name || "Archivo seleccionado";
            validarFormulario();
        });
    }

    if (inputAnio && inputMes && submitBtn) {
        inputAnio.addEventListener("change", validarFormulario);
        inputMes.addEventListener("change", validarFormulario);
    }

    function validarFormulario() {
        if (
            inputAnio.value.trim() !== "" &&
            inputMes.value.trim() !== "" &&
            inputArchivo.files.length > 0
        ) {
            submitBtn.disabled = false;
            submitBtn.classList.remove("bg-gray-400", "cursor-not-allowed");
            submitBtn.classList.add("bg-blue-600", "hover:bg-blue-700");
        } else {
            submitBtn.disabled = true;
            submitBtn.classList.add("bg-gray-400", "cursor-not-allowed");
            submitBtn.classList.remove("bg-blue-600", "hover:bg-blue-700");
        }
    }

    // Inicializa el estado del bot√≥n
    validarFormulario();
});
</script>
{% endblock %}
